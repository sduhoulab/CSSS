<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>齐鲁健康哨兵系统</title>
    <script src="chart.js" type="text/javascript"></script>
    <script src="chartjs-adapter-date-fns.js"></script>
    <script src="echarts.min.js" type="text/javascript"></script>
    <script src="zip-fs-full.min.js" type="text/javascript"></script>
    <script src="lodash.min.js" type="text/javascript"></script>
    <style>
    @keyframes gradientText {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    .title-container {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
    }
    
    .main-title {
        font-size: 2.5em;
        font-weight: bold;
        background: linear-gradient(120deg, #1a75ff, #00ccff, #1a75ff, #ff1a1a, #ff6666, #ff1a1a);
        background-size: 200% auto;
        color: transparent;
        -webkit-background-clip: text;
        background-clip: text;
        animation: gradientText 5s ease infinite;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .main-subtitle {
        font-size: 1.5em;
        font-weight: bold;
        background: linear-gradient(120deg,  #1a75ff, #00ccff, #1a75ff, #ff1a1a, #ff6666, #ff1a1a);
        background-size: 200% auto;
        color: transparent;
        -webkit-background-clip: text;
        background-clip: text;
        animation: gradientText 5s ease infinite;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(255, 0, 0, 0.1);
    }
    
    .title-underline {
        width: 100px;
        height: 4px;
        background: linear-gradient(90deg, #1a75ff, #00ccff);
        margin: 10px auto;
        border-radius: 2px;
        box-shadow: 0 2px 4px rgba(255, 0, 0, 0.2);
    }

    body {
    background-color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
        .container {
            /* width: 100%; */
            padding: 20px;
            margin-top: 20px;
            margin-left: 20px;
            margin-right: 500px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
            min-height: 80vh;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .time-range {
            display: inline-flex;
            align-items: center;
        }
        select {
            height: 30px;
            padding: 0 10px;
        }
        .time-range label {
            margin-right: 10px;
        }
        .time-range input {
            margin-right: 20px;
            height: 26px;
        }
        .chart-container {
            width: 100%;
            margin-top: 20px;
            height: 100px;
        }
        .maps-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        .map-container {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

    </style>
</head>
<body>

    <div class="container">
        <div class="title-container">
            <h1 class="main-title">齐鲁健康哨兵系统</h1>
            <h2 class="main-subtitle">Cheeloo Public Health Sentinel System</h2>
            <div class="title-underline"></div>
        </div>
        <div class="controls">
            <select id="diseaseSelect">
                <option value="">选择疾病</option>
            </select>
                <!-- Cascading City/County Dropdowns -->
            <div class="cascading-controls">
              <label for="citySelect">市:</label>
              <select id="citySelect">
                <option value="">选择市</option>
              </select>
              <label for="countySelect">县:</label>
              <select id="countySelect">
                <option value="">选择县</option>
              </select>
            </div>
            <!-- <select id="countySelect">
                <option value="">选择县</option>
            </select> -->
            <div class="time-range">
                <label for="startDate">开始时间:</label>
                <input type="date" id="startDate">
                <label for="endDate">截止时间:</label>
                <input type="date" id="endDate">
            </div>
        </div>

        <div class="chart-container">
            <canvas id="timeSeriesChart"></canvas>
        </div>
        <div class="maps-grid">
            
            <!-- <div id="map1" class="map-container"></div> -->
            <div id="map2" class="map-container"></div>
            <div id="map3" class="map-container"></div>
            <!-- <div id="map4" class="map-container"></div> -->
        </div>
    </div>
      
    <script src="app.js"></script>
    <script src="observable-slim.js"></script>
    <!-- <script src="https://unpkg.com/observable-slim"></script> -->
    <script>

var lastMessageId = null;

// Options for the observer (which mutations to observe)
const config = { attributes: false, childList: true, subtree: true };

// Callback function to execute when mutations are observed
const debouncedCallback = _.debounce((message) => {
  const els = document.querySelectorAll('div[data-message-id]');
  _lastMessageId = els[0]?.getAttribute('data-message-id');
  _lastMessageText = els[0]?.innerText;
  if(_lastMessageId != lastMessageId && _lastMessageText.includes('特定关键词')){
    lastMessageId = _lastMessageId;
    console.log('Detected specific keyword in the latest message:', _lastMessageText);

    // Extract the JSON-like block between { ... }
    const jsonMatch = _lastMessageText.match(/\{([\s\S]*?)\}/);

    if (jsonMatch) {
      try {
        // Parse the JSON block
        const data = JSON.parse(`{${jsonMatch[1]}}`);

        // Map Chinese keys to English variable names
        const result = {
          disease: data["疾病"] || "",
          county: data["地区"] || "",
          startDate: data["开始时间"] || "",
          endDate: data["结束时间"] || ""
        };

        console.log(result);
        // Output: { disease: '手足口', county: '历下区', startDate: '2024-01-01', endDate: '2024-12-31' }

        document.getElementById('diseaseSelect').value = result.disease;
        document.getElementById('diseaseSelect').dispatchEvent(new Event('change', { bubbles: true }));
        const city = findCityByCounty(result.county);
        document.getElementById('citySelect').value = city;
        document.getElementById('citySelect').dispatchEvent(new Event('change', { bubbles: true }));
        document.getElementById('countySelect').value = result.county;
        document.getElementById('countySelect').dispatchEvent(new Event('change', { bubbles: true }));
        document.getElementById('startDate').value = result.startDate;
        document.getElementById('startDate').dispatchEvent(new Event('change', { bubbles: true }));
        document.getElementById('endDate').value = result.endDate;
        document.getElementById('endDate').dispatchEvent(new Event('change', { bubbles: true }));

      } catch (err) {
        console.error("Failed to parse JSON:", err);
      }
    } else {
      console.error("No JSON block found in text.");
    }
  }
  console.log(message, els[0]);
}, 3000);

const callback = (mutationList, observer) => {
  debouncedCallback('Mutation observed');
};

// Create an observer instance linked to the callback function
const observer = new MutationObserver(callback);

// Later, you can stop observing
// observer.disconnect();

// Wait/poll helper: retry until document.querySelectorAll returns at least one node
function waitForMessageDivs(interval = 1000) {
  console.log('Starting to wait for message divs...');
  const tryFind = () => {
    console.log('Trying to find message divs...');
    const els = document.querySelectorAll('div[data-scroll-element]');
    if (els && els.length > 0) {
      console.log('Message divs found:', els);
      observer.observe(els[0], config);
    } else {
      setTimeout(tryFind, interval);
    }
  };
  tryFind();
}


window.addEventListener('hashchange', function() {
  const url = new URL(window.location.href)
  disease = utf8_encode(url.hash.substring(1))
  console.log('Hash changed to disease:', disease)
  document.getElementById('diseaseSelect').value = disease
  document.getElementById('diseaseSelect').dispatchEvent(new Event('change', { bubbles: true }))
}, false);

</script>

<script src="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.2.0-beta.10/libs/cn/index.js"></script>
<script>
chatBot = new CozeWebSDK.WebChatClient({
  config: {
    // bot_id: '7562900217298010153',
    bot_id: '7563837428906573876',
  },
  componentProps: {
    title: '对话智能体',
  },
  auth: {
    type: 'token',
    // token: 'pat_RLdA5zxNjPCW893IKcqs3hLOD6WuCdaewsubjuB5M3kW45u4QszjkV6qT0u3Fras',
    token: 'pat_Pxyw8SA5vQPLBM2Tu9CETja57xhMMV8naBGPE793csb1vN4J2FPXFu52Q0wzmWhX',
    onRefreshToken: function () {
      // return 'pat_RLdA5zxNjPCW893IKcqs3hLOD6WuCdaewsubjuB5M3kW45u4QszjkV6qT0u3Fras'
      return 'pat_Pxyw8SA5vQPLBM2Tu9CETja57xhMMV8naBGPE793csb1vN4J2FPXFu52Q0wzmWhX'
    }
  }, 
  ui: {
    footer: {
      isShow: false,
      expressionText: 'Powered by ...',
    },
    chatBot:{
      isNeedAudio: true,
      uploadable: false,
      onShow:()=> {
        waitForMessageDivs();
        debouncedCallback('Chat bot shown');
      }
    }
  }
});

chatBot.showChatBot();

</script>

</body>
</html>